- name: Hash
  type: alias array uint8
  size: 32
  print: hex

# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: BlockHeader
  type: struct
  comment: The block header data structure which gets 2xSHA256 hashed and used as a link by blocks.

  layout:
    - name: Version
      type: uint32
      comment: Indicates which set of block validation rules to follow

    - name: HashPrevBlock
      type: Hash
      comment: 2xSHA256 hash of the previous 'BlockHeader' structure. This field is what orders blocks in the blockchain.

    - name: HashMerkleRoot
      type: Hash
      comment: The merkle root hash of the transactions in the 'Block' structure

    - name: Time
      type: uint32
      comment: Unix epoch time when the block was mined (according to the miner)

    - name: Target
      type: array uint8 #TODO: add nbits type
      size: 4
      print: hex
      comment: Sets the mining difficulty

    - name: Nonce
      type: uint32
      comment: Field that is changed when trying to mine a block
 
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: Script
  type: struct
  comment: The bitcoin stack based programming language

  layout:
    - name: ScriptSize
      type: varint
      comment: Size of the 'Script' array in bytes.

    - name: Script
      type: array uint8
      size: ScriptSize
      print: hex
      comment: The raw script program.

# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: Witness
  type: struct
  comment: The segregated witness (segwit) data which was seperated from the 'Script' structure, as part of BIP141

  layout:
    - name: StackSize
      type: varint
      comment: The size of the stack in bytes

    - name: Stack
      type: array uint8
      size: StackSize
      print: hex
      comment: Binary stack containing unlocking data, such as signatures


- name: WitnessData
  type: struct
  comment: Array that contains witness data for each input

  layout:
    - name: NumWitnesses
      type: varint

    - name: Witnesses
      type: array Witness
      size: NumWitnesses

# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: Input
  type: struct
  comment: Bitcoin input transaction

  layout:
    - name: TxOutId
      type: array uint8
      size: 32
      print: hex
      comment: The unspent transaction output id (UTXO). This is a double SHA256 hash of the serialized data of a previous 'Transaction' struct.

    - name: TxOutIdx
      type: uint32
      comment: The index of the 'Output' transaction in the above UTXO, which is being sent/unlocked.

    - name: Script
      type: Script
      comment: The unlocking script for 'TxOutIdx'

    - name: Sequence
      type: uint32
      comment: Originally intended to be used for modification of transactions in the mempool, but is now used for timelocks

# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: Output
  type: struct
  comment: Bitcoin output transaction

  layout:
    - name: Value
      type: uint64
      comment: The number of satoshis to send (must be a subset of the total amount that is unlocked in the 'Input' struct)

    - name: Script
      type: Script
      comment: The locking script

# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: Transaction
  type: struct
  comment: A Bitcoin transaction

  layout:
    - name: Version
      type: uint32
      comment: todo

    - name: Flag
      type: uint16
      condition: Flag
      condition_operation: equals
      condition_value: 256
      comment: Only present if the value is 256 (is used to indicate whether there is witness data) 

    - name: NumInputs
      type: varint
      comment: Total number of inputs that will be distributed to outputs.

    - name: Inputs
      type: array Input
      size: NumInputs
      comment: The inputs that will be sent to outputs.

    - name: NumOutputs
      type: varint
      comment: Total number of outputs that will receive bitcoins from above inputs.

    - name: Outputs
      type: array Output
      size: NumOutputs
      comment: The outputs that will receive bitcoins from the inputs.

    - name: WitnessData
      type: array WitnessData
      size: NumInputs
      condition: Flag
      condition_operation: equals
      condition_value: 256
      comment: The segregated witness data of the inputs.

    - name: LockTime
      type: uint32
      comment: Block height (if below 500 million) or Unix Epoch timestamp (if above 500 million) when transaction is final.
      
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: BlockPreamble
  type: struct
  comment: The data that always precedes a bitcoin block

  layout:
    - name: MagicNo
      type: uint32
      comment: Must always be '0xD9B4BEF9'

    - name: BlockSize
      type: uint32
      comment: The size of the following block in bytes

# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

- name: Block
  type: struct
  comment: A Bitcoin block that is added to the blockchain

  layout:
    - name: BlockHeader
      type: BlockHeader

    - name: TransactionCount
      type: varint

    - name: Transactions
      type: array Transaction
      size: TransactionCount


# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
